
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Salt States &#8212; Caktus Developer Documentation 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Custom Salt States" href="custom_states.html" />
    <link rel="prev" title="Adding Margarita to a project that uses Salt" href="adding.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="salt-states">
<h1>Salt States<a class="headerlink" href="#salt-states" title="Permalink to this headline">¶</a></h1>
<div class="section" id="sls-files">
<h2>SLS files<a class="headerlink" href="#sls-files" title="Permalink to this headline">¶</a></h2>
<div class="section" id="base">
<span id="id1"></span><h3>base<a class="headerlink" href="#base" title="Permalink to this headline">¶</a></h3>
<p>Installs packages like <cite>build-essential</cite> and <cite>sudo</cite> that all
our servers need.</p>
<p>No configuration.</p>
</div>
<div class="section" id="elasticsearch">
<span id="id2"></span><h3>elasticsearch<a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h3>
<p>Adds a repo, installs, and arranges for the service to run at startup
for elasticsearch.</p>
<p>Always adds the elasticsearch-analysis-icu plugin.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">elasticsearch_version</span></code> (string):  E.g. ‘1.7’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">elasticsearch_newrelic</span></code> (boolean): Whether to use a newrelic plugin to monitor
the elasticsearch service in more detail.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#newrelic-npi"><span class="std std-ref">newrelic_npi</span></a> (if <code class="docutils literal notranslate"><span class="pre">elasticsearch_newrelic</span></code> is True).</p></li>
</ul>
</div>
<div class="section" id="fail2ban">
<span id="id3"></span><h3>fail2ban<a class="headerlink" href="#fail2ban" title="Permalink to this headline">¶</a></h3>
<p>Installs and runs fail2ban.</p>
<p>No configuration.</p>
</div>
<div class="section" id="forward-logs">
<span id="id4"></span><h3>forward_logs<a class="headerlink" href="#forward-logs" title="Permalink to this headline">¶</a></h3>
<p>Arranges for all syslog messages to be copied to a remote server
(e.g. Papertrail).</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">secrets:LOG_DESTINATION</span></code> (string): The host:port to forward the messages to,
e.g. “log3.example.com:12345”.</p></li>
</ul>
</div>
<div class="section" id="locale-utf8">
<span id="id5"></span><h3>locale.utf8<a class="headerlink" href="#locale-utf8" title="Permalink to this headline">¶</a></h3>
<p>Sets the system locale, both <code class="docutils literal notranslate"><span class="pre">LANG</span></code> and <code class="docutils literal notranslate"><span class="pre">LC_ALL</span></code>, to <code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span></code>.</p>
<p>No configuration.</p>
</div>
<div class="section" id="memcached">
<span id="id6"></span><h3>memcached<a class="headerlink" href="#memcached" title="Permalink to this headline">¶</a></h3>
<p>Installs and runs memcached.</p>
<p>Leaves all settings and configuration at their defaults.</p>
<p>No configuration.</p>
</div>
<div class="section" id="newrelic-npi">
<span id="id7"></span><h3>newrelic_npi<a class="headerlink" href="#newrelic-npi" title="Permalink to this headline">¶</a></h3>
<p>Install the <a class="reference external" href="https://docs.newrelic.com/docs/plugins/plugins-new-relic/installing-plugins/installing-npi-compatible-plugin">New Relic Platform Installer</a>
that can be used to easily install compatible plugins.</p>
<p>This can be pre-reqed by other states but probably does not need to
be included directly.</p>
<p>No configuration.</p>
</div>
<div class="section" id="newrelic-sysmon">
<span id="id8"></span><h3>newrelic_sysmon<a class="headerlink" href="#newrelic-sysmon" title="Permalink to this headline">¶</a></h3>
<p>Install and configure the NewRelic monitor for the whole system
(monitors CPU, memory usage, etc.)</p>
<p>Note that if the key is not set in pillar, this state is a no-op, so
it’s safe to always include it and then just set the key on the
systems where you want to monitor.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">secrets:NEW_RELIC_LICENSE_KEY</span></code> (string): The license key of the New Relic
account to use.</p></li>
</ul>
</div>
<div class="section" id="nginx">
<span id="id9"></span><h3>nginx<a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h3>
<p>Install nginx, tweak the default configuration in the main config file,
and remove the default site config that gets installed.</p>
<p>Uses the Nginx PPA to get the latest stable version.</p>
<p>No configuration.</p>
</div>
<div class="section" id="nginx-cert">
<span id="id10"></span><h3>nginx.cert<a class="headerlink" href="#nginx-cert" title="Permalink to this headline">¶</a></h3>
<p>Installs (but does not run) a script, <code class="docutils literal notranslate"><span class="pre">/var/lib/nginx/generate-cert.sh</span></code>,
for creating self-signed certificates for nginx.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nginx"><span class="std std-ref">nginx</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="nodejs">
<span id="id11"></span><h3>nodejs<a class="headerlink" href="#nodejs" title="Permalink to this headline">¶</a></h3>
<p>Installs node, making sure there’s a <code class="docutils literal notranslate"><span class="pre">/usr/bin/node</span></code> executable.</p>
<p>No configuration.</p>
</div>
<div class="section" id="postfix">
<span id="id12"></span><h3>postfix<a class="headerlink" href="#postfix" title="Permalink to this headline">¶</a></h3>
<p>Install and run postfix mail system.</p>
<p>No configuration.</p>
</div>
<div class="section" id="postgresql">
<span id="id13"></span><h3>postgresql<a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h3>
<p>Install the configured version of the Postgres database server.  For older
versions, makes sure that UTF-8 locale is the default for the main cluster.
(For newer versions, it comes set up that way.)</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">postgres_version</span></code> (string): Postgres version to install, e.g. “9.4”.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#locale-utf8"><span class="std std-ref">locale.utf8</span></a></p></li>
</ul>
</div>
<div class="section" id="postgresql-client">
<span id="id14"></span><h3>postgresql.client<a class="headerlink" href="#postgresql-client" title="Permalink to this headline">¶</a></h3>
<p>Install the configured version of the Postgres database client.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">postgres_version</span></code> (string): Postgres version to install, e.g. “9.4”.</p></li>
</ul>
<p>No dependencies.</p>
</div>
<div class="section" id="project-cache">
<span id="id15"></span><h3>project.cache<a class="headerlink" href="#project-cache" title="Permalink to this headline">¶</a></h3>
<p>Open the firewall for memcached from <a class="reference internal" href="minions.html#minions"><span class="std std-ref">app_minions</span></a>.</p>
<p>Dependency on <a class="reference internal" href="#memcached"><span class="std std-ref">memcached</span></a> state will also ensure memcached is installed.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#memcached"><span class="std std-ref">memcached</span></a></p></li>
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="project-db">
<span id="id16"></span><h3>project.db<a class="headerlink" href="#project-db" title="Permalink to this headline">¶</a></h3>
<p>Sets up a project user and database in Postgres.</p>
<p>Updates Postgres server config to accept connections from
<a class="reference internal" href="minions.html#minions"><span class="std std-ref">app_minions</span></a>.</p>
<p>Roles:</p>
<ul>
<li><p>If role is <code class="docutils literal notranslate"><span class="pre">db-master</span></code> or <code class="docutils literal notranslate"><span class="pre">db-slave</span></code>, sets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wal_level</span> <span class="o">=</span> <span class="n">hot_standby</span>
<span class="n">hot_standby</span> <span class="o">=</span> <span class="n">on</span>
<span class="n">hot_standby_feedback</span> <span class="o">=</span> <span class="n">on</span>
<span class="n">wal_keep_segments</span> <span class="o">=</span> <span class="mi">128</span>
</pre></div>
</div>
</li>
</ul>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">secrets:DB_PASSWORD</span></code> (string): Password to assign to the project’s Postgres user.</p></li>
</ul>
<p>The following configuration parameters in postgresql.conf can be
set by putting a corresponding setting under <code class="docutils literal notranslate"><span class="pre">postgresql_config</span></code>
in Pillar:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_connections</span></code>: default is 100.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shared_buffers</span></code>: default is “24MB”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">work_mem</span></code>: default is “1MB”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maintenance_work_mem</span></code>: default is “16MB”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wal_buffers</span></code>: default is “-1”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">commit_delay</span></code>: default is 0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">commit_siblings</span></code>: default is 5.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_segments</span></code>: default is 32</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_timeout</span></code>: default is “10min”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_completion_target</span></code>: default is ‘0.9’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">effective_cache_size</span></code>: default “128MB”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code>: default “250ms”.</p></li>
</ul>
<p>The following parameters can be set the same way, but are ignored
unless the role is <code class="docutils literal notranslate"><span class="pre">db-master</span></code> or <code class="docutils literal notranslate"><span class="pre">db-slave</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_wal_senders</span></code>: default is ‘0’</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#postgresql"><span class="std std-ref">postgresql</span></a></p></li>
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
</ul>
</div>
<div class="section" id="project-devs">
<span id="id17"></span><h3>project.devs<a class="headerlink" href="#project-devs" title="Permalink to this headline">¶</a></h3>
<p>Create local users on the server and give them ssh access.</p>
<p>Pillar configuration:</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">users</span></code> dictionary in the pillar. Each dictionary key
should be a username. The value of that dictionary should be another
dictionary, with one key <code class="docutils literal notranslate"><span class="pre">public_key</span></code> containing a list, each entry
of which is a public SSH key for that user.  (Paste it in from their
public key file, one long line.)  E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span><span class="p">:</span>
  <span class="n">user1</span><span class="p">:</span>
    <span class="n">public_key</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span> <span class="n">ADFSDFSDFDFSDFSDF</span><span class="o">....</span><span class="n">DFSDFSDFSDF</span>
  <span class="n">user2</span><span class="p">:</span>
    <span class="n">public_key</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span> <span class="n">DFSUDFJSDJFSDJKF</span><span class="o">...</span><span class="n">SDFJSDKFSDF</span>
</pre></div>
</div>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#users-groups"><span class="std std-ref">users.groups</span></a></p></li>
</ul>
</div>
<div class="section" id="project-dirs">
<span id="id18"></span><h3>project.dirs<a class="headerlink" href="#project-dirs" title="Permalink to this headline">¶</a></h3>
<p>Arrange for the project’s main directories to be created, e.g.
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;</span></code>,
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/log</span></code>,
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/ssh</span></code>, and
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/services</span></code>.</p>
<p>Directories are owned by the project user.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code> (string): Used to construct the paths.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#project-user"><span class="std std-ref">project.user</span></a></p></li>
</ul>
</div>
<div class="section" id="project-django">
<span id="id19"></span><h3>project.django<a class="headerlink" href="#project-django" title="Permalink to this headline">¶</a></h3>
<p>Creates a <code class="docutils literal notranslate"><span class="pre">manage.sh</span></code> file in the project directory that invokes
the Django management tool with the right settings.</p>
<p>Depends on other sls files that also do Django-related setup.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#project-user"><span class="std std-ref">project.user</span></a></p></li>
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-venv"><span class="std std-ref">project.venv</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="project-queue">
<span id="id20"></span><h3>project.queue<a class="headerlink" href="#project-queue" title="Permalink to this headline">¶</a></h3>
<p>Arrange for rabbitmq server to be installed and run.</p>
<p>Create rabbitmq user named <code class="docutils literal notranslate"><span class="pre">&lt;project_name&gt;_&lt;environment&gt;</span></code>, with
password <code class="docutils literal notranslate"><span class="pre">BROKER_PASSWORD</span></code> from secrets.</p>
<p>Open the firewall for rabbitmq access to other <a class="reference internal" href="minions.html#minions"><span class="std std-ref">app_minions</span></a> servers.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">secrets:BROKER_PASSWORD</span></code>: (string) The password to set on the rabbitmq user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code> (string)</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#rabbitmq"><span class="std std-ref">rabbitmq</span></a></p></li>
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
</ul>
</div>
<div class="section" id="project-repo">
<span id="id21"></span><h3>project.repo<a class="headerlink" href="#project-repo" title="Permalink to this headline">¶</a></h3>
<p>Checks out the appropriate version of the project source code to
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/source</span></code>.  Or if environment is <code class="docutils literal notranslate"><span class="pre">local</span></code>,
rsyncs from the current local directory to the source dir on vagrant.</p>
<p>Create the <code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/source/.env</span></code> file containing all
the environment settings needed to run the project.</p>
<p>Create a wrapper script <code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/source/dotenv.sh</span></code>
that sets up the environment from <code class="docutils literal notranslate"><span class="pre">.env</span></code> then runs another command.
E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">project</span>
<span class="n">source</span><span class="o">/</span><span class="n">dotenv</span><span class="o">.</span><span class="n">sh</span> <span class="n">env</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="n">source</span><span class="o">/</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
</pre></div>
</div>
<p>Note that any pillar variable you create inside the <code class="docutils literal notranslate"><span class="pre">env</span></code> dictionary or the <code class="docutils literal notranslate"><span class="pre">secrets</span></code> dictionary
will be added to the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file and the <code class="docutils literal notranslate"><span class="pre">dotenv.sh</span></code> script. Both gunicorn and celery are
launched with the <code class="docutils literal notranslate"><span class="pre">dotenv.sh</span></code> wrapper, so all of those variables will be available as environment
variables to all of the web and worker processes.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">github_deploy_key</span></code> (string): Optional, contains text of the Github deploy key
to use to access the repository.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">repo:url</span></code> (string): Git repository URL</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">branch</span></code> (string): Branch to check out. Optional; the default is <code class="docutils literal notranslate"><span class="pre">master</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code> (string)</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-user"><span class="std std-ref">project.user</span></a></p></li>
<li><p><a class="reference internal" href="#version-control"><span class="std std-ref">version-control</span></a></p></li>
<li><p><a class="reference internal" href="#sshd-github"><span class="std std-ref">sshd.github</span></a></p></li>
</ul>
</div>
<div class="section" id="project-user">
<span id="id22"></span><h3>project.user<a class="headerlink" href="#project-user" title="Permalink to this headline">¶</a></h3>
<p>Create a local user named <code class="docutils literal notranslate"><span class="pre">&lt;project_name&gt;</span></code> and add it to the
<code class="docutils literal notranslate"><span class="pre">www-data</span></code> group.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code> (string)</p></li>
</ul>
</div>
<div class="section" id="project-venv">
<span id="id23"></span><h3>project.venv<a class="headerlink" href="#project-venv" title="Permalink to this headline">¶</a></h3>
<p>Create a virtualenv for the project (at <code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/env</span></code>)
and install Python requirements listed in <code class="docutils literal notranslate"><span class="pre">requirements_file</span></code>. By default,
requirements will be installed from
<code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/source/requirements/dev.txt</span></code> if the
environment is <code class="docutils literal notranslate"><span class="pre">local</span></code>, and otherwise from <code class="docutils literal notranslate"><span class="pre">production.txt</span></code>.</p>
<p>If a New Relic key is configured, ensures the <code class="docutils literal notranslate"><span class="pre">newrelic</span></code> agent package
is installed in the virtual env.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This also installs <code class="docutils literal notranslate"><span class="pre">ghostscript</span></code>, even though <a class="reference internal" href="#python"><span class="std std-ref">python</span></a> already does that.
We should fix that.</p>
</div>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code> (string)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_version</span></code> (string): version of python to use</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requirements_file</span></code> (string): path to the project requirements file
(relative to the project root)</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-repo"><span class="std std-ref">project.repo</span></a></p></li>
<li><p><a class="reference internal" href="#python"><span class="std std-ref">python</span></a></p></li>
</ul>
</div>
<div class="section" id="project-web-app">
<span id="id24"></span><h3>project.web.app<a class="headerlink" href="#project-web-app" title="Permalink to this headline">¶</a></h3>
<p>Arranges for gunicorn to run the Django server, and for running deploy-time
commands like <code class="docutils literal notranslate"><span class="pre">collectstatic</span></code> and <code class="docutils literal notranslate"><span class="pre">migrate</span></code>.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">less_version</span></code>: What version of the LESS CSS compilation tool to install.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#supervisor-pip"><span class="std std-ref">supervisor.pip</span></a></p></li>
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-venv"><span class="std std-ref">project.venv</span></a></p></li>
<li><p><a class="reference internal" href="#project-django"><span class="std std-ref">project.django</span></a></p></li>
<li><p><a class="reference internal" href="#postfix"><span class="std std-ref">postfix</span></a></p></li>
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
<li><p><a class="reference internal" href="#nodejs"><span class="std std-ref">nodejs</span></a></p></li>
</ul>
</div>
<div class="section" id="project-web-balancer">
<span id="id25"></span><h3>project.web.balancer<a class="headerlink" href="#project-web-balancer" title="Permalink to this headline">¶</a></h3>
<p>Arranges for nginx to serve static files for the project and to proxy
other requests to the gunicorn servers.</p>
<p>Set <code class="docutils literal notranslate"><span class="pre">letsencrypt:</span> <span class="pre">true</span></code> in the pillar configuration, and remove any
<code class="docutils literal notranslate"><span class="pre">ssl_cert</span></code> and <code class="docutils literal notranslate"><span class="pre">ssl_key</span></code>, to
use <a class="reference external" href="https://letsencrypt.org">letsencrypt.org</a> to generate a certificate
that will be trusted by all major browsers, and to renew it periodically.
But this can only work if there’s a single web server and the domain points
directly at it. (You might still be able to use <cite>letsencrypt</cite> some other way.)</p>
<p>If you wish to use <cite>letsencrypt</cite> with multiple domain names, add a list
of domains under <code class="docutils literal notranslate"><span class="pre">letsencrypt_domains</span></code> in the pillar configuration. (If you
do not set this parameter, letsencrypt defaults to using your pillar config’s
<cite>domain</cite> property.)</p>
<p>Note: to switch to letsencrypt from another certificate, it should be
enough to set <code class="docutils literal notranslate"><span class="pre">letsencrypt</span></code> and <code class="docutils literal notranslate"><span class="pre">admin_email</span></code>, remove <code class="docutils literal notranslate"><span class="pre">ssl_key</span></code> and
<code class="docutils literal notranslate"><span class="pre">ssl_cert</span></code>, and deploy again.
But the reverse is not true: if you want to switch from letsencrypt
to any other type of certificate, you’ll want to manually remove the
symbolic links in <code class="docutils literal notranslate"><span class="pre">/var/www/project_name/ssl/</span></code> before turning off
letsencrypt and running another deploy. Otherwise the new cert will
get copied to the symbolic links, which will overwrite the
letsencrypt certs stored in <code class="docutils literal notranslate"><span class="pre">/etc/letsencrypt</span></code>, which will lead to
very confusing behavior if you ever try to switch back to
letsencrypt.</p>
<p>If you already have a certificate you want to use, you can provide it
in the pillar configuration; see below.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">letenscrypt</span></code> is not set and either a key or certificate are not
provided, the deploy will generate and use a self-signed key.</p>
<p>Summary of which certificates will be used:</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">ssl_key</span></code> and <code class="docutils literal notranslate"><span class="pre">ssl_cert</span></code> are provided, they will be used.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">letsencrypt</span></code> is true, letsencrypt will be used.</p></li>
<li><p>Otherwise, a self-signed certificate will be used.</p></li>
</ul>
<p>The nginx configuration redirects non-SSL requests to the corresponding
<cite>https</cite> URL, and sets the <code class="docutils literal notranslate"><span class="pre">Strict-Transport-Security</span></code> header to a
very long time.</p>
<p>This state can also set up basic Auth for a site if <code class="docutils literal notranslate"><span class="pre">http_auth</span></code> is set
(see configuration below).</p>
<p>If there are multiple hosts with the <cite>web</cite> role, then each nginx
will be configured to proxy requests to Django workers on all the
<cite>web</cite> hosts. I guess if we didn’t put a load balancer in front of our
web servers, we could just point our DNS at one of
them and it would spread the load across all of them.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">http_auth</span></code> (dictionary): If provided, turn on HTTP Basic Auth on the site,
and set up a password file for access using each key in the dictionary as a username
and each corresponding value as that user’s password.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">domain</span></code> (string): The web server, and if relevant the SSL certificate, will
be configured to use this domain name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">letsencrypt</span></code> (boolean): If True, use <a class="reference external" href="https://letsencrypt.org">letsencrypt.org</a>
to get a certificate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">letsencrypt_domains</span></code> (list): List of domain names. We’ll request SSL certs for
each domain name in this list. If this is empty or not set, we’ll use <code class="docutils literal notranslate"><span class="pre">domain</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">admin_email</span></code> (email address): If <code class="docutils literal notranslate"><span class="pre">letsencrypt</span></code> is true, this is required to
provide an email address for <a class="reference external" href="https://letsencrypt.org">letsencrypt.org</a> to use.
This should be a dev team group email address, not an individual’s email address.
This address does not need to be in the site’s domain.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssl_key</span></code> (string): Contents of the SSL key to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssl_cert</span></code> (string): Contents of the SSL certificate to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dhparam_numbits</span></code> (integer): How many bits to use when generating the DHE
parameters. (optional, default 2048).  Generating the DHE file is a one-time
task, so changing this parameter after it’s been generated will have no effect
unless you manually remove <code class="docutils literal notranslate"><span class="pre">/var/www/&lt;project_name&gt;/ssl/dhparams.pem</span></code>
first.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nginx"><span class="std std-ref">nginx</span></a></p></li>
<li><p><a class="reference internal" href="#nginx-cert"><span class="std std-ref">nginx.cert</span></a></p></li>
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
</ul>
</div>
<div class="section" id="project-worker-beat">
<span id="id28"></span><h3>project.worker.beat<a class="headerlink" href="#project-worker-beat" title="Permalink to this headline">¶</a></h3>
<p>Arrange for <code class="docutils literal notranslate"><span class="pre">celery</span> <span class="pre">beat</span></code> service to run for the project via supervisor.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code></p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#supervisor-pip"><span class="std std-ref">supervisor.pip</span></a></p></li>
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-venv"><span class="std std-ref">project.venv</span></a></p></li>
</ul>
</div>
<div class="section" id="project-worker-default">
<span id="id29"></span><h3>project.worker.default<a class="headerlink" href="#project-worker-default" title="Permalink to this headline">¶</a></h3>
<p>Arrange for a <code class="docutils literal notranslate"><span class="pre">celery</span> <span class="pre">worker</span></code> service to run for the project via supervisor.
The default worker-specific command-line arguments set log level to <code class="docutils literal notranslate"><span class="pre">INFO</span></code>.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_name</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">celery_worker_arguments</span></code> (string): Optional, overrides default worker-specific
command-line arguments.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#supervisor-pip"><span class="std std-ref">supervisor.pip</span></a></p></li>
<li><p><a class="reference internal" href="#project-dirs"><span class="std std-ref">project.dirs</span></a></p></li>
<li><p><a class="reference internal" href="#project-venv"><span class="std std-ref">project.venv</span></a></p></li>
<li><p><a class="reference internal" href="#postfix"><span class="std std-ref">postfix</span></a></p></li>
</ul>
</div>
<div class="section" id="python">
<span id="id30"></span><h3>python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
<p>Installs the version of python specified in Pillar as <code class="docutils literal notranslate"><span class="pre">python_version</span></code>, along with a variety of
dev libraries like <code class="docutils literal notranslate"><span class="pre">libjpeg8-dev</span></code> that are needed to install various Python packages like Pillow,
as well as setuptools, pip, and virtualenv. You can manually specify additional header packages that
are needed by adding them as a list in the <code class="docutils literal notranslate"><span class="pre">python_headers</span></code> pillar variable. This state also makes
a few symlinks that help with building Pillow on 64bit systems.</p>
<p>If you are using Python 2.7, you can set <code class="docutils literal notranslate"><span class="pre">python_backport</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> which will enable the
Python 2.7.9+ backport for network security enhancements. See
<a class="reference external" href="https://www.python.org/dev/peps/pep-0466/">https://www.python.org/dev/peps/pep-0466/</a>. This setting has no effect if you are not using Python
2.7.</p>
<p>(If you’re wondering why it installs Ghostscript, that too is required
by some of the imaging tools we sometimes install.)</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">python_version</span></code> (string)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_backport</span></code> (Boolean)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_headers</span></code> (list) List of additional apt packages to be installed.</p></li>
</ul>
</div>
<div class="section" id="rabbitmq">
<span id="id31"></span><h3>rabbitmq<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h3>
<p>Install rabbitmq and make it run.</p>
<p>Delete the default <code class="docutils literal notranslate"><span class="pre">guest</span></code> rabbitmq user.</p>
<p>No configuration.</p>
</div>
<div class="section" id="redis-master">
<span id="id32"></span><h3>redis-master<a class="headerlink" href="#redis-master" title="Permalink to this headline">¶</a></h3>
<p>Install redis server and make it listen on localhost only.</p>
<p>No configuration or dependencies.</p>
</div>
<div class="section" id="salt-master">
<span id="id33"></span><h3>salt.master<a class="headerlink" href="#salt-master" title="Permalink to this headline">¶</a></h3>
<p>Opens ports 4505 and 4506.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="solr">
<span id="id34"></span><h3>solr<a class="headerlink" href="#solr" title="Permalink to this headline">¶</a></h3>
<p>Installs <code class="docutils literal notranslate"><span class="pre">openjdk-7-jre-headless</span></code>.</p>
<p>No configuration.</p>
</div>
<div class="section" id="solr-project">
<span id="id35"></span><h3>solr.project<a class="headerlink" href="#solr-project" title="Permalink to this headline">¶</a></h3>
<p>Installs Solr and copies the default stopwords file into its
configuration.</p>
<p>Does not appear to arrange to run it.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#solr"><span class="std std-ref">solr</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="sshd">
<span id="id36"></span><h3>sshd<a class="headerlink" href="#sshd" title="Permalink to this headline">¶</a></h3>
<p>Install and run openssh client and server.</p>
<p>Configure ssh server, disabling root login, and restricting access
so only users in the <code class="docutils literal notranslate"><span class="pre">login</span></code> group may ssh into the server.</p>
<p>Opens port 22.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ufw"><span class="std std-ref">ufw</span></a></p></li>
<li><p><a class="reference internal" href="#fail2ban"><span class="std std-ref">fail2ban</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="sshd-github">
<span id="id37"></span><h3>sshd.github<a class="headerlink" href="#sshd-github" title="Permalink to this headline">¶</a></h3>
<p>Add <code class="docutils literal notranslate"><span class="pre">github.com</span></code> to the system known hosts file.</p>
<p>No configuration.</p>
</div>
<div class="section" id="statsd">
<span id="id38"></span><h3>statsd<a class="headerlink" href="#statsd" title="Permalink to this headline">¶</a></h3>
<p>Install statsd and provide basic default configuration, arranging
for it to run on startup.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nodejs"><span class="std std-ref">nodejs</span></a></p></li>
<li><p><a class="reference internal" href="#version-control"><span class="std std-ref">version-control</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="syslog">
<span id="id39"></span><h3>syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h3>
<p>Arrange to install rsyslog v8.5 or later.</p>
<p>Configure it to load the <cite>imfile</cite> module so that other states
can add rsyslog config files to tell rsyslog to monitor plain
text log files.</p>
<p>No configuration.</p>
</div>
<div class="section" id="sudo">
<span id="id40"></span><h3>sudo<a class="headerlink" href="#sudo" title="Permalink to this headline">¶</a></h3>
<p>Arrange for sudo service to run.</p>
<p>Update the <code class="docutils literal notranslate"><span class="pre">sudoers</span></code> config file to let users in group <code class="docutils literal notranslate"><span class="pre">admin</span></code>
do anything without a password.</p>
<p>No configuration.</p>
</div>
<div class="section" id="supervisor">
<span id="id41"></span><h3>supervisor<a class="headerlink" href="#supervisor" title="Permalink to this headline">¶</a></h3>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version forever: </span>Use <code class="docutils literal notranslate"><span class="pre">supervisor.pip</span></code> instead.</p>
</div>
<p>Install and run supervisor using its Debian/Ubuntu package.</p>
<p>No configuration.</p>
</div>
<div class="section" id="supervisor-pip">
<span id="id42"></span><h3>supervisor.pip<a class="headerlink" href="#supervisor-pip" title="Permalink to this headline">¶</a></h3>
<p>Install and run supervisor after installing it globally using
<code class="docutils literal notranslate"><span class="pre">pip</span></code>, first uninstalling the packaged supervisor if necessary.</p>
</div>
<div class="section" id="ufw">
<span id="id43"></span><h3>ufw<a class="headerlink" href="#ufw" title="Permalink to this headline">¶</a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">ufw</span></code> firewall package and set it to deny access
by default.</p>
<p>No configuration.</p>
</div>
<div class="section" id="unattended-upgrades">
<span id="id44"></span><h3>unattended_upgrades<a class="headerlink" href="#unattended-upgrades" title="Permalink to this headline">¶</a></h3>
<p>Arrange for <code class="docutils literal notranslate"><span class="pre">apt</span></code> to install security updates weekly and
notify someone of the results.</p>
<p>Regardless of the configuration, will never update any <code class="docutils literal notranslate"><span class="pre">salt-*</span></code>
packages.</p>
<p>Pillar configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">admin_email</span></code> (string): Required; email address to send notifications of
the update results to</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unattended_upgrade_blacklist</span></code> (list of strings and regexes): Optional package name
not to ever upgrade this way. Can include both exact names of packages and regexes
that match package names.</p></li>
</ul>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#syslog"><span class="std std-ref">syslog</span></a></p></li>
</ul>
</div>
<div class="section" id="users-groups">
<span id="id45"></span><h3>users.groups<a class="headerlink" href="#users-groups" title="Permalink to this headline">¶</a></h3>
<p>Create system user groups named <code class="docutils literal notranslate"><span class="pre">admin</span></code> and <code class="docutils literal notranslate"><span class="pre">login</span></code>.</p>
<p>No configuration.</p>
</div>
<div class="section" id="vagrant-user">
<span id="id46"></span><h3>vagrant.user<a class="headerlink" href="#vagrant-user" title="Permalink to this headline">¶</a></h3>
<p>Add the <code class="docutils literal notranslate"><span class="pre">vagrant</span></code> user to the <code class="docutils literal notranslate"><span class="pre">admin</span></code> and <code class="docutils literal notranslate"><span class="pre">login</span></code> groups so that
with our updated configuration for <code class="docutils literal notranslate"><span class="pre">ssh</span></code> and <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, the vagrant user
can still login and do things as root.</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#users-groups"><span class="std std-ref">users.groups</span></a></p></li>
</ul>
<p>No configuration.</p>
</div>
<div class="section" id="version-control">
<span id="id47"></span><h3>version-control<a class="headerlink" href="#version-control" title="Permalink to this headline">¶</a></h3>
<p>Install git, mercurial, and subversion.</p>
<p>No configuration.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Caktus Developer Documentation</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../dev-setup.html">Developer Machine Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Developer Machine Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../branching.html">Branching Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rds.html">Using Amazon RDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supported-clients.html">Supported Browsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">App Development Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading-django.html">Upgrading Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-strategies.html">Choosing a deploy strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dokku.html">Deploying to a Dokku server</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="margarita.html">Margarita</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="adding.html">Adding Margarita to a project that uses Salt</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Salt States</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_states.html">Custom Salt States</a></li>
<li class="toctree-l2"><a class="reference internal" href="grains.html">Grains</a></li>
<li class="toctree-l2"><a class="reference internal" href="pillar.html">Salt Pillar</a></li>
<li class="toctree-l2"><a class="reference internal" href="minions.html">Minions</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrading.html">Upgrading Margarita</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project-template-testing.html">Django Project Template Testing Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend-packages.html">Frontend Packaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">External Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/index.html">Deploying Django projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hosting-practices.html">Hosting best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/frontend.html">Front-end JavaScript Testing Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws.html">Amazon Web Services (AWS)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="margarita.html">Margarita</a><ul>
      <li>Previous: <a href="adding.html" title="previous chapter">Adding Margarita to a project that uses Salt</a></li>
      <li>Next: <a href="custom_states.html" title="next chapter">Custom Salt States</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Caktus Group.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/margarita/states.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>